# =================================================================
# Простой Docker Compose для запуска базовой CI/CD инфраструктуры
# =================================================================
#
# Этот файл запускает 3 основных сервиса:
# 1. Jenkins: CI/CD сервер (http://localhost:8080)
# 2. SonarQube: Анализатор качества кода (http://localhost:9000)
# 3. Nexus: Менеджер артефактов (http://localhost:8081)
#
# Команда для запуска:
# docker-compose -f docker-compose.simple.yml up -d
#
# Команда для остановки:
# docker-compose -f docker-compose.simple.yml down
#
# =================================================================

version: '3.8'

services:
  # 1. Jenkins - Сервер для автоматизации CI/CD
  # ------------------------------------------------
  # URL: http://localhost:8080
  # Назначение: Сборка, тестирование и развертывание ваших проектов.
  jenkins:
    image: jenkins/jenkins:lts-jdk17 # Ис��ользуем образ с Java 17
    container_name: jenkins
    restart: unless-stopped
    ports:
      - "8080:8080" # Веб-интерфейс
      - "50000:50000" # Для подключения agent-нод
    volumes:
      - jenkins_data:/var/jenkins_home # Сохраняет данные Jenkins между перезапусками
    environment:
      - "JAVA_OPTS=-Djenkins.install.runSetupWizard=false" # Отключает мастер первоначальной настройки

  # 2. SonarQube - Платформа для анализа качества кода
  # ---------------------------------------------------
  # URL: http://localhost:9000
  # Логин/Пароль: admin / admin
  # Назначение: Поиск багов, уязвимостей и "запахов" в коде.
  sonarqube:
    image: sonarqube:10.3-community # Стабильная community-версия
    container_name: sonarqube
    restart: unless-stopped
    ports:
      - "9000:9000" # Веб-интерфейс
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true # Необходимо ��ля запуска в Docker

  # 3. Nexus - Менеджер репозиториев артефактов
  # ------------------------------------------------
  # URL: http://localhost:8081
  # Назначение: Хранение и кеширование зависимостей (Maven, npm) и сборок.
  nexus:
    image: sonatype/nexus3:3.63.0 # Конкретная версия для стабильности
    container_name: nexus
    restart: unless-stopped
    ports:
      - "8081:8081" # Веб-интерфейс
    volumes:
      - nexus_data:/nexus-data # Сохраняет данные Nexus

# Docker Volumes для сохранения данных
volumes:
  jenkins_data:
    driver: local
  sonarqube_data:
    driver: local
  sonarqube_extensions:
    driver: local
  sonarqube_logs:
    driver: local
  nexus_data:
    driver: local

