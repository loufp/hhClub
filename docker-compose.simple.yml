# =================================================================
# Простой Docker Compose для запуска базовой CI/CD инфраструктуры  
# =================================================================
#
# Этот файл запускает 3 основных сервиса в изолированном режиме:
# 1. Jenkins: CI/CD сервер (внутри Docker сети)
# 2. SonarQube: Анализатор качества кода (внутри Docker сети) 
# 3. Nexus: Менеджер артефактов (внутри Docker сети)
#
# Команда для запуска:
# docker-compose -f docker-compose.simple.yml up -d
#
# Команда для остановки:
# docker-compose -f docker-compose.simple.yml down
#
# Примечание: Сервисы работают изолированно, порты не пробрасываются
# для совместимости с любыми ОС и избежания конфликтов портов
# =================================================================


services:
  # 1. Jenkins - Сервер для автоматизации CI/CD
  # ------------------------------------------------
  # Назначение: Сборка, тестирование и развертывание ваших проектов.
  jenkins:
    image: jenkins/jenkins:lts-jdk17 # Используем образ с Java 17
    container_name: jenkins
    restart: unless-stopped
    volumes:
      - jenkins_data:/var/jenkins_home # Сохраняет данные Jenkins между перезапусками
    environment:
      - "JAVA_OPTS=-Djenkins.install.runSetupWizard=false" # Отключает мастер первоначальной настройки

  # 2. SonarQube - Платформа для анализа качества кода
  # ---------------------------------------------------
  # Логин/Пароль по умолчанию: admin / admin
  # Назначение: Поиск багов, уязвимостей и "запахов" в коде.
  sonarqube:
    image: sonarqube:10.3-community # Стабильная community-версия
    container_name: sonarqube
    restart: unless-stopped
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true # Необходимо для запуска в Docker
      - SONAR_JDBC_URL=jdbc:h2:mem:sonar # Используем встроенную H2 БД
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9000/api/system/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # 3. Nexus - Менеджер репозиториев артефактов
  # ------------------------------------------------
  # Назначение: Хранение и кеширование зависимостей (Maven, npm) и сборок.
  nexus:
    image: sonatype/nexus3:3.63.0 # Конкретная версия для стабильности
    container_name: nexus
    restart: unless-stopped
    volumes:
      - nexus_data:/nexus-data # Сохраняет данные Nexus
    environment:
      - INSTALL4J_ADD_VM_PARAMS=-Xms1200m -Xmx1200m # Оптимизация памяти
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8081/service/rest/v1/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

# Docker Volumes для сохранения данных
volumes:
  jenkins_data:
    driver: local
  sonarqube_data:
    driver: local
  sonarqube_extensions:
    driver: local
  sonarqube_logs:
    driver: local
  nexus_data:
    driver: local
