image: golang:1.21

stages:
  - build
  - test
  - package
  - deploy

build_job:
  stage: build
  script:
    - go build ./...
    - go test ./...

test_job:
  stage: test
  script:
    - echo 'Running tests...'
    - go test ./...

package_job:
  stage: package
  script:
    - docker build -t myapp:latest .
    - echo 'Docker image built successfully'

deploy_job:
  stage: deploy
  script:
    - echo 'Deploy: tagging and pushing image to registry (requires CI_REGISTRY and credentials)'
    - if [ -n "$CI_REGISTRY" ] && [ -n "$CI_REGISTRY_IMAGE" ]; then docker tag myapp:latest $CI_REGISTRY_IMAGE:latest && docker push $CI_REGISTRY_IMAGE:latest; else echo 'CI registry variables not set, skipping push'; fi
    - if [ -n "$KUBE_CONFIG_BASE64" ]; then echo $KUBE_CONFIG_BASE64 | base64 -d > kubeconfig && KUBECONFIG=kubeconfig kubectl apply -f k8s/ || echo 'no k8s manifests or KUBE_CONFIG_BASE64 not set'; fi

